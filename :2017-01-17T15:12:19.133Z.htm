<!DOCTYPE html>
<html>
<head>
</head>
<body>
<p style="text-align: center;"><strong>Windows Backup в сетевое хранилище</strong></p>
<p style="text-align: justify;">&nbsp;Как известно Windows Backup не хранит несколько резервных копий одновременно, если резервирование выполняется в сетевое хранилище. Однако Могучий Шел позволяет нивелировать данную проблему. Данный скрипт удаляет резервную копию старше <strong>двух недель</strong> и выполняет новое резервирование:</p>
<pre>$date = get-date -DisplayHint date -UFormat %Y-%m-%d<br />$twoweeksago = get-date (get-date).addDays(-14) -UFormat %Y-%m-%d<br /><br />$ChekFolder = "\\server\backup\sys-$twoweeksago"<br />$FileExists = Test-Path $ChekFolder<br />If ($FileExists -eq $True) {<br />rmdir -R \\server\backup\sys-$twoweeksago<br />}<br /><br />mkdir \\server\backup\sys-$date<br />wbadmin start systemstatebackup -backupTarget:\\server\backup\sys-$date -quiet</pre>
<p style="text-align: justify;">&nbsp;Трюк заключается в том, что каждый раз резервное копирование выполняется в новую папку, которая создаётся на основании текущей даты.<br />&nbsp;Сам скрипт выполняется планировщиком задач:</p>
<p><img class="" style="display: block; margin-left: auto; margin-right: auto;" src="http://fs.exonix.ru/powershell/task1.png" alt="" width="789" height="761" /></p>
<p style="text-align: justify;">&nbsp;Так же можно выполнить резервное копирование и виртуальных машин. При чём я рекомендовал бы это делать в отдельных командах, тогда создастся отдельный образ каждой виртуальной машины:</p>
<pre>$date = get-date -DisplayHint date -UFormat %Y-%m-%d<br />$twoweeksago = get-date (get-date).addDays(-14) -UFormat %Y-%m-%d<br /><br />$ChekFolder = "\\server\backup\$twoweeksago"<br />$FileExists = Test-Path $ChekFolder<br />If ($FileExists -eq $True) {<br />rmdir -R \\server\backup\$twoweeksago<br />}<br /><br />mkdir \\server\backup\$date\DC1<br />mkdir \\server\backup\$date\VPN1<br />mkdir \\server\backup\$date\IIS1<br />mkdir \\server\backup\$date\TFS1<br /><br />WBADMIN START BACKUP -hyperv:DC1 -backupTarget:\\server\backup\$date\DC1 -quiet<br />WBADMIN START BACKUP -hyperv:VPN1 -backupTarget:\\server\backup\$date\VPN1 -quiet<br />WBADMIN START BACKUP -hyperv:IIS1 -backupTarget:\\server\backup\$date\IIS1 -quiet<br />WBADMIN START BACKUP -hyperv:TFS1 -backupTarget:\\server\backup\$date\TFS1 -quiet</pre>
<p>&nbsp;Восстановление резервной копии виртуальной машины:</p>
<pre>PS C:\&gt; wbadmin get versions -backupTarget:\\192.168.1.1\e$\BACKUP\VM1<br />wbadmin 1.0 - Backup command-line tool<br />(C) Copyright 2013 Microsoft Corporation. All rights reserved.<br /><br />Backup time: 21.04.2018 04:27<br />Backup location: Network Share labeled \\backupserver\2018-04-21\VM1<br />Version identifier: <strong>04/21/2018-02:27</strong><br />Can recover: Volume(s), File(s), Application(s), Virtual Machine(s)<br /><br /><br />PS C:\&gt; wbadmin get items -version:<strong>04/21/2018-02:27</strong> -backuptarget:\\192.168.1.1\e$\BACKUP\VM1<br />wbadmin 1.0 - Backup command-line tool<br />(C) Copyright 2013 Microsoft Corporation. All rights reserved.<br /><br />Volume ID = {a19569cf-bbdc-49d2-958f-3e1ae77a23e7}<br />Volume 'VHDX', mounted at V: at the time the backup was created<br />Volume size = 1535.87 GB<br />Can recover = Selected files<br /><br />Application = HyperV<br />VM name: VM1<br />VM caption: Online\VM1<br />VM identifier: 0ACABF6D-5523-42CC-975F-EA5A4AECB257<br />Total Size: 31.48 GB<br /><br />wbadmin start recovery -version:<strong>04/21/2018-02:27</strong> -itemType:<strong>hyperv</strong> -items:VM1 -backupTarget:\\192.168.1.1\e$\BACKUP\VM1 <strong>-alternateLocation -recoverytarget:D:\Hyper-V\</strong></pre>
</body>
</html>