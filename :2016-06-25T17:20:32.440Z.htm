<!DOCTYPE html>
<html>
<head>
</head>
<body>
<p style="text-align: center;"><strong>Мониторинг VPN</strong></p>
<p>&nbsp;Хотите знать кто, когда и откуда подключался к вашему VPN серверу? Для этого понадобится один скрипт Powershell и&nbsp;база данных.<br />Собственно, сам Powershell скрипт, расположенный на&nbsp;RAIDUS сервере и&nbsp;который запускает планировщик задач каждую ночь в 00:05:</p>
<pre>Add-Type -Path "C:\Program Files (x86)\MySQL\MySQL Connector Net 6.9.8\Assemblies\v4.5\MySql.Data.dll" <br />$connectionString = "server=mysql1;uid=root;pwd=asdASD;database=VPN;" <br />$connection = New-Object MySql.Data.MySqlClient.MySqlConnection <br />$connection.ConnectionString = $connectionString <br />$connection.Open() <br />$sql = New-Object MySql.Data.MySqlClient.MySqlCommand <br />$sql.Connection = $connection<br />$today = get-date -DisplayHint date -UFormat %Y-%m-%d<br />$yesterday = get-date (get-date).addDays(-1) -UFormat %Y-%m-%d<br />#Get-WinEvent -FilterHashTable @{LogName="security";endtime="$today";id=6272} | Foreach {<br />Get-WinEvent -FilterHashTable @{LogName="security";starttime="$yesterday";endtime="$today";id=6272} | Foreach {<br />$Name = $_.Properties[0].Value<br />$FullName = (Get-ADUser $Name).Name<br />$LocalIP = $_.Properties[8].Value<br />$RemoteIP = $_.Properties[9].Value<br />$Time = Get-Date $_.TimeCreated -UFormat "%H:%M:%S"<br />$Date = Get-Date $_.TimeCreated -UFormat "%Y-%m-%d"<br />$sql.CommandText = "INSERT INTO connections (Day,Login,Name,VPN_IP,Client_IP) VALUES ('$Date','$Time','$FullName','$LocalIP','$RemoteIP')" <br />&nbsp;&nbsp; $sql.ExecuteNonQuery()<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />$connection.Close()</pre>
<p>&nbsp;Комментарии по скрипту:</p>
<p>&nbsp;- первая строка: путь&nbsp;к <a href="https://dev.mysql.com/downloads/connector/net/" target="_blank" rel="noopener">коннектору</a>, с помощью которого Powershell подключается к базе данных MySQL на Debian.<br />&nbsp;- вторая строка: подключение к серверу mysql1 под учётной записью root (root от MySQL, а не от сервера Debian).<br />&nbsp;- восьмая строка: определение текущей даты.<br />&nbsp;- девятая строка: определение вчерашней даты.<br />&nbsp;- десятая строка: чтение всех событий в журнале безопасности. Эту строку следует <strong>рас</strong>комментировать при первом ручном&nbsp;запуске скрипта.<br />&nbsp;- одиннадцатая строка: чтение событий в журнале безопасности за вчерашний день. Эту строку следует <strong>за</strong>комментировать при первом ручном&nbsp;запуске скрипта.<br />&nbsp;-&nbsp;<strong>Name</strong> и <strong>FullName</strong>: определение&nbsp;полного имени пользователя по его SID. SID всегда постоянен, а вот в логах могут стоять имена пользователей в разных видах. Например, Username или DOMAIN\Username.<br />&nbsp;- <strong>LocalIP</strong>: IP адрес VPN сервера. Вдруг их несколько.<br />&nbsp;- <strong>RemoteIP</strong>: внешний&nbsp;IP адрес, с которого подключается клиент.<br />&nbsp;- <strong>Time</strong>: время подключения.<br />&nbsp;- <strong>Date</strong>: день подключения.<br />&nbsp;- Последние четыре строки: выполнение запроса MySQL - запись в базу данных.</p>
<p>&nbsp;Вот такие две таблицы должны быть созданы в базе данных VPN:</p>
<pre>mysql&gt; <strong>show create table `connections`</strong>;<br />+-------------+------------------------------+<br />| Table&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | Create Table&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |<br />+-------------+------------------------------+<br />| connections | CREATE TABLE `connections` (<br />&nbsp; `Day` date NOT NULL,<br />&nbsp; `Login` time NOT NULL,<br />&nbsp; `Name` varchar(30) NOT NULL,<br />&nbsp; `VPN_IP` varchar(15) NOT NULL,<br />&nbsp; `Client_IP` varchar(15) NOT NULL,<br />&nbsp; `Country2` varchar(255) NOT NULL<br />) ENGINE=InnoDB DEFAULT CHARSET=utf8 |<br />+-------------+------------------------------+<br />1 row in set (0.00 sec)<br /><br />mysql&gt; <strong>show create table `IPs`</strong>;<br />+-------+------------------------------------+<br />| Table | Create Table&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |<br />+-------+------------------------------------+<br />| IPs&nbsp;&nbsp; | CREATE TABLE `IPs` (<br />&nbsp; `StartIP` varchar(15) NOT NULL,<br />&nbsp; `EndIP` varchar(15) NOT NULL,<br />&nbsp; `Country` varchar(255) NOT NULL<br />) ENGINE=InnoDB DEFAULT CHARSET=utf8 |<br />+-------+------------------------------------+<br />1 row in set (0.00 sec)</pre>
<p>&nbsp;После этого, база данных будет выглядеть так:<br /><img width="540" height="140" style="margin-right: auto; margin-left: auto; display: block;" alt="" src="http://fs.exonix.ru/powershell/vpnmon/vpnmon1.png" />&nbsp;Теперь необходимо определить, какой стране принадлежит IP адрес пользователя VPN. Есть несколько способов, в том числе определение онлайн через php, но&nbsp;мне это намного&nbsp;сложнее сделать, да к тому же определение будет выполняться всякий раз, при обновлении веб-страницы. По этому,&nbsp;создаём ещё одну таблицу в базе данных, в которую импортируем файл <a href="http://fs.exonix.ru/powershell/vpnmon/ip.csv">CSV с IP и странами</a>, последнюю версию "GeoLite Country" которого можно скачать <a href="http://dev.maxmind.com/geoip/legacy/geolite/" target="_blank" rel="noopener">тут</a>. Импорт я делал через <a href="http://www.heidisql.com/download.php">HeidiSQL</a>.<br />&nbsp;Теперь необходимо настроить MySQL так, чтобы он проверял IP, и записывал соответствующую страну в поле Country2. Для этого используется планировщик событий MySQL. Скрипт выполняется на две минуты позже, после скрипта PowerShell:</p>
<pre>CREATE EVENT `Country Update` ON SCHEDULE EVERY 1 DAY STARTS "2016-06-26 00:07:00" DO UPDATE connections SET connections.country2 = (SELECT IPs.country as country2 FROM IPs WHERE INET_ATON(connections.Client_IP) &gt;= INET_ATON(IPs.StartIP) AND INET_ATON(connections.Client_IP) &lt;= INET_ATON(IPs.EndIP) ) WHERE Client_IP=Client_IP AND COUNTRY2 = "";</pre>
<p>&nbsp;Команду после DO нужно выполнить сразу после ручного запуска скрипта Powershell. Если она написана правильно, то таблица примет вид:</p>
<p><img width="534" height="134" style="margin-right: auto; margin-left: auto; display: block;" alt="" src="http://fs.exonix.ru/powershell/vpnmon/vpnmon2.png" /></p>
<p>&nbsp;Проверку созданного события по расписанию можно проверить с помощью команды:</p>
<pre>SELECT * FROM INFORMATION_SCHEMA.EVENTS WHERE EVENT_NAME = 'Country update' AND EVENT_SCHEMA = 'VPN'\G;</pre>
<pre>*************************** 1. row ***************************<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; EVENT_CATALOG: def<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; EVENT_SCHEMA: VPN<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; EVENT_NAME: Country Update<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DEFINER: <a href="mailto:root@mysql1.domainad.domain.com">root@mysql1.domainad.domain.com</a><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; TIME_ZONE: SYSTEM<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; EVENT_BODY: SQL<br />&nbsp;&nbsp;&nbsp; EVENT_DEFINITION: UPDATE connections SET connections.country2 = (SELECT IPs.country as country2 FROM IPs WHERE INET_ATON(connections.Client_IP) &gt;= INET_ATON(IPs.StartIP) AND INET_ATON(connections.Client_IP) &lt;= INET_ATON(IPs.EndIP) ) WHERE Client_IP=Client_IP AND COUNTRY2 = ""<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; EVENT_TYPE: RECURRING<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; EXECUTE_AT: NULL<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; INTERVAL_VALUE: 1<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; INTERVAL_FIELD: DAY<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SQL_MODE:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; STARTS: 2016-06-26 00:07:00<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ENDS: NULL<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; STATUS: ENABLED<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ON_COMPLETION: NOT PRESERVE<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; CREATED: 2016-06-25 14:50:25<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LAST_ALTERED: 2016-06-25 14:50:25<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LAST_EXECUTED: 2016-07-02 00:07:00<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; EVENT_COMMENT:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ORIGINATOR: 0<br />CHARACTER_SET_CLIENT: utf8<br />COLLATION_CONNECTION: utf8_general_ci<br />&nbsp; DATABASE_COLLATION: utf8_general_ci<br />1 row in set (0.00 sec)<br /><br />ERROR:<br />No query specified</pre>
<p>&nbsp;На этом можно заканчивать. Если у вас есть знакомые веб-программисты, то они легко вам сделают веб-страницу с выводом нужной информации. Я же пока не буду выкладывать свой вариант, так как там не всё гладко работает... Примерно, это выглядит так:</p>
<p><img width="1023" height="276" style="margin-right: auto; margin-left: auto; display: block;" alt="" src="http://fs.exonix.ru/powershell/vpnmon/vpnmon3.png" /></p>
<p style="text-align: justify;">&nbsp;Если есть вопросы по настройке - спрашивайте, помогу. К сожалению, пока не нашёл, как можно определить выход пользователя, чтобы рассчитать время его сессии. А так же не нашёл как определить в логах по каким протоколам пользователь подключается к VPN. Например, у меня два сервера: L2TP на 2012 R2, и IKEv2 на 2008 R2, т.к. второй на 2012 R2 не работает. Если у вас есть какая-либо информация, буду рад если поделитесь в комментариях. Спасибо!</p>
<p style="text-align: right;">02.07.2016</p>
<div id="vk_comments"></div>
</body>
</html>