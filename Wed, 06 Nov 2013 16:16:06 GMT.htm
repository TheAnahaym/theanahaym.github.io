<!DOCTYPE html>
<html>
<head>
</head>
<body>
<p style="text-align: justify;">&nbsp;Приступим к миграции пользователя User1. Напомню схему сети, в которой происходит миграция. Так же хочу напомнить, что при использовании SBS сервера речи о предоставлении ресурсов через доверительные отношения быть не может. А следовательно, новый пользователь теряет доступ к ресурсам SBS и для доступа к ним должен использовать учётные данные исходного домена, т.е. SBS.</p>
<p><img width="708" height="303" style="display: block; margin-left: auto; margin-right: auto;" src="http://fs.exonix.ru/exch/2013/net4.png" /></p>
<p><img width="1024" height="768" style="display: block; margin-left: auto; margin-right: auto;" alt="" src="http://fs.exonix.ru/exch/2013/mig13.png" /></p>
<p style="text-align: justify;">&nbsp;Все команды выполняются на целевом сервере Exchange 20<strong>13</strong>. Первые команды необходимы для авторизации на серверах. Вводить учётные данные нужно в том виде, в котором они изображены на рисунках ниже. Хотя в интернете много тем с ошибкой авторизации при данном виде ввода. Рекомендацией было вводить учётные данные исходного сервера как <strong>exonix.localnet\alex</strong>. Но те темы касались миграции между Exchange 2010 и предыдущими.</p>
<pre style="text-align: justify;">$LocalCredentials = Get-Credential<br />$RemoteCredentials = Get-Credential</pre>
<p><img width="1024" height="768" style="display: block; margin-left: auto; margin-right: auto;" alt="" src="http://fs.exonix.ru/exch/2013/mig14.png" /></p>
<p><img width="1024" height="768" style="display: block; margin-left: auto; margin-right: auto;" alt="" src="http://fs.exonix.ru/exch/2013/mig15.png" /></p>
<p style="text-align: justify;">&nbsp;Exchange включает в себя некоторые скрипты, один из которых для <a href="http://technet.microsoft.com/ru-ru/library/ee861103(v=exchg.150).aspx" target="_blank" rel="noopener">подготовки и копирования учётной записи</a> (без пароля) в новый домен. Почему нельзя использовать ADMT для миграции пользователей - это ограничение SBS редакции. Она не поддерживает доверительные отношения между доменами (ещё один повод перейти на "полноценный" домен), которые нужны для ADMT. Переходим в директорию со скриптами и запускаем нужный нам:</p>
<pre style="text-align: justify;">cd 'C:\Program Files\Microsoft\Exchange Server\V15\Scripts'<br /><br />.\Prepare-MoveRequest.ps1 -Identity user1@exonix.localnet -RemoteForestDomainController <strong>dc1ex1</strong>.exonix.localnet -RemoteForestCredential $RemoteCredentials -LocalForestDomainController <strong>dc12r2</strong>.domain.internal -LocalForestCredential $LocalCredentials</pre>
<p style="text-align: justify;">&nbsp;Если необходимо создать учётную запись пользователя в определённой OU, то используется ключ <strong>-TargetMailUserOU</strong>. Далее можно разом назначить "пароль по умолчанию" для всех учётных записей в этой OU с помощью команды&nbsp;<a href="http://technet.microsoft.com/en-us/library/ee617261.aspx" target="_blank" rel="noopener">Set-ADAccountPassword</a>. Обратите внимание, что в скрипте используются имена исходного SBS сервера и целевого <strong>контроллера домена</strong>.</p>
<p><img width="1024" height="768" style="display: block; margin-left: auto; margin-right: auto;" alt="" src="http://fs.exonix.ru/exch/2013/mig16.png" /></p>
<p>&nbsp;Затем выполняем саму миграцию почтового ящика:</p>
<pre>&nbsp;New-MoveRequest -Identity user1 -Remote -RemoteGlobalCatalog "dc1ex1.exonix.localnet" -RemoteCredential $RemoteCredentials -TargetDeliveryDomain "domain.internal" -remotehostname dc1ex1.exonix.localnet</pre>
<p><img width="1024" height="768" style="display: block; margin-left: auto; margin-right: auto;" alt="" src="http://fs.exonix.ru/exch/2013/mig17.png" /></p>
<p style="text-align: justify;">&nbsp;Если для исходного почтового ящика было включено Архивирование, то по умолчанию и почтовый ящик и архив мигрируют в одну базу данных. Для для миграции почтового ящика и архива в соответствующие базы данных используют следующие ключи (г<span>де archive - база данный для архива, а "</span><span>Mailbox Database 0912552619" база данных для почтовых ящиков, созданная по умолчанию)</span>:</p>
<pre style="text-align: justify;"><span>New-MoveRequest -Identity user1 -Remote -RemoteGlobalCatalog "dc1ex1.exonix.localnet" -RemoteCredential $RemoteCredentials -TargetDeliveryDomain "domain.internal" -remotehostname dc1ex1.exonix.localnet</span>&nbsp;-ArchiveTargetDatabase archive -TargetDatabase "Mailbox Database 0912552619"</pre>
<p style="text-align: justify;">&nbsp;После миграции необходим назначить пароль учётной записи, активировать её и переместить в нужное организационное подразделение. Во время миграции переносятся все серверные настройки. Не переносятся настройки Outlook.</p>
<p><img width="1024" height="768" style="display: block; margin-left: auto; margin-right: auto;" alt="" src="http://fs.exonix.ru/exch/2013/mig18.png" /></p>
<p><img width="1024" height="768" style="display: block; margin-left: auto; margin-right: auto;" alt="" src="http://fs.exonix.ru/exch/2013/mig19.png" /></p>
<p style="text-align: justify;">&nbsp;В исходном домене после миграции учётная запись не блокируется, но становится без разрешённой функции почты, а сам почтовый ящик перемещается в "отключённые". Его можно вновь кому-нибудь подключить.</p>
<p><img width="1024" height="768" style="display: block; margin-left: auto; margin-right: auto;" alt="" src="http://fs.exonix.ru/exch/2013/mig20.png" /></p>
<p style="text-align: justify;">&nbsp;На этом миграция завершена. Далее приведу список некоторых ошибок, с которыми пришлось столкнуться.</p>
<p style="text-align: justify;">&nbsp;Из-за неполного проброса <a href="http://blogs.technet.com/b/exchange/archive/2010/08/10/3410619.aspx" target="_blank" rel="noopener">всех нужных портов</a> через NAT получал ошибку подключения к контроллеру домена:</p>
<pre class="prettyprint prettyprinted"><strong><span class="typ">Source</span><span class="pln"> </span><span class="typ">Domain</span><span class="pln"> controller unavailable </span><span class="kwd">or</span><span class="pln"> authentication failed</span></strong><span class="pun">.</span><span class="pln">
</span><span class="typ">At</span><span class="pln"> C</span><span class="pun">:</span><span class="pln">\Program </span><span class="typ">Files</span><span class="pln">\Microsoft\Exchange </span><span class="typ">Server</span><span class="pln">\V</span><span class="lit">15</span><span class="pln">\Scripts\Prepare</span><span class="pun">-</span><span class="typ">MoveRequest</span><span class="pun">.</span><span class="pln">ps1</span><span class="pun">:</span><span class="lit">1190</span><span class="pln"> </span><span class="kwd">char</span><span class="pun">:</span><span class="lit">9</span><span class="pln">
</span><span class="pun">+</span><span class="pln">         </span><span class="kwd">throw</span><span class="pln"> </span><span class="str">"Source Domain controller unavailable or authentication failed."</span></pre>
<p style="text-align: justify;">&nbsp;Из-за неверного ключа -RemoteLegacy, вместо верного ключа -Remote.</p>
<pre><span class="typ">Failed</span><span class="pln"> to reconnect to </span><span class="typ">Active</span><span class="pln"> </span><span class="typ">Directory</span><span class="pln"> server dc1ex1</span><span class="pun">.</span><span class="pln">company</span><span class="pun">.</span><span class="pln">localnet</span><span class="pun">.</span><span class="pln"> </span><span class="typ">Make</span><span class="pln"> sure the server </span><span class="kwd">is</span><span class="pln"> available</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">and</span><span class="pln"> that you have used the correct credentials</span><span class="pun">.</span><span class="pln">
    </span><span class="pun">+</span><span class="pln"> </span><span class="typ">CategoryInfo</span><span class="pln">          </span><span class="pun">:</span><span class="pln"> </span><span class="typ">NotSpecified</span><span class="pun">:</span><span class="pln"> </span><span class="pun">(:)</span><span class="pln"> </span><span class="pun">[</span><span class="typ">New</span><span class="pun">-</span><span class="typ">MoveRequest</span><span class="pun">],</span><span class="pln"> </span><span class="typ">RemoteTransientException</span></pre>
<p style="text-align: justify;">&nbsp;Из-за неверного значения ключа&nbsp;-TargetDeliveryDomain. Нужно указать почтовый домен, я же вначале указывал FQDN сервера:</p>
<pre class="prettyprint prettyprinted"><span class="typ">The</span><span class="pln"> target mail user </span><span class="str">'user1'</span><span class="pln"> doesn</span><span class="str">'t have an SMTP address that matches the in</span></pre>
<p style="text-align: justify;">&nbsp;Из-за отсутствия правильного сертификата будет следующая ошибка:</p>
<pre class="prettyprint prettyprinted"><span class="typ">The</span><span class="pln"> call to </span><span class="str">'https://dc1ex1.company.localnet/EWS/mrsproxy.svc'</span><span class="pln"> failed</span><span class="pun">.</span><span class="pln"> </span><span class="typ">Error</span><span class="pln"> details</span><span class="pun">:</span><span class="pln"> </span><span class="typ">Could</span><span class="pln"> </span><span class="kwd">not</span><span class="pln"> establish trust
relationship </span><span class="kwd">for</span><span class="pln"> the SSL</span><span class="pun">/</span><span class="pln">TLS secure channel </span><span class="kwd">with</span><span class="pln"> authority </span><span class="str">'dc1ex1.company.localnet'</span><span class="pun">.</span><span class="pln"> </span><span class="pun">--&gt;</span><span class="pln"> </span><span class="typ">The</span><span class="pln"> underlying connection was
closed</span><span class="pun">:</span><span class="pln"> </span><span class="typ">Could</span><span class="pln"> </span><span class="kwd">not</span><span class="pln"> establish trust relationship </span><span class="kwd">for</span><span class="pln"> the SSL</span><span class="pun">/</span><span class="pln">TLS secure channel</span><span class="pun">.</span><span class="pln"> </span><span class="pun">--&gt;</span><span class="pln"> </span><span class="typ">The</span><span class="pln"> remote certificate </span><span class="kwd">is</span><span class="pln"> invalid
according to the validation procedure</span><span class="pun">..</span></pre>
<p style="text-align: right;"><em>06.11.2013</em></p>
<p style="text-align: justify;"></p>
<div id="vk_comments"></div>
</body>
</html>