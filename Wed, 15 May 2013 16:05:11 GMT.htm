<!DOCTYPE html>
<html>
<head>
</head>
<body>
<div>
<ul class="dropdown" data-jkit="[menu]">
<li><a href="#!Статьи.Exchange.Postfix_-_ClamAv_-_Exchange_2010">Postfix, ClamAV, Exchange 2010</a>
<ul class="sub_menu">
<li><a href="#!Статьи.Exchange.Резервное_копирование_баз_Exchange_2010_SP2">Резервное копирование баз Exchange 2010 SP2</a></li>
<li><a href="#!Статьи.Exchange.Установка_Exchange_2013">Установка Exchange 2013</a></li>
<li><a href="#!Статьи.Exchange.Базовая_настройка_Exchange_2013">Базовая настройка Exchange 2013</a></li>
<li><a href="#!Статьи.Exchange.Exchange_2010_PowerShell">Exchange 2010 PowerShell</a></li>
</ul>
</li>
</ul>
</div>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p style="text-align: justify;">&nbsp; <span style="font-size: medium;"><strong>Установка почтового шлюза на Postfix для почтового сервера MS Exchange 2010.</strong></span></p>
<p style="text-align: justify;">&nbsp;Данная статья предназначена для новичков. Для тех, кто никогда не устанавливал и не настраивал Postfix. Или для тех, кто не настраивал Exchange как back-end сервер.</p>
<p style="text-align: justify;">&nbsp;</p>
<p style="text-align: justify;">&nbsp;И так имеем тестовую схему.&nbsp;&nbsp;В данном случае IP адресация не имеет значения.</p>
<p><img style="display: block; margin-left: auto; margin-right: auto;" alt="" src="http://fs.exonix.ru/fw4.png" /></p>
<p style="text-align: justify;">&nbsp;Маршуртизатор (в моём случае DIR-100) имел правила на проброс портов 25 (SMTP) на внутренний адрес MS Exchange сервера. Для подключения POP3 клиентов нужно создать правила для портов 110 (POP3), 995 (POP3S).&nbsp;Так же были правила брэндмауэра, разрешающие трафик по SMTP между серверами Ubuntu и MS Exchange. Если вы будете подключать клиентов из интернета, вам нужно будет разрешить подключения по 443 порту для ActiveSync &amp; Autodiscover.</p>
<p style="text-align: justify;">&nbsp;На сервер 192.168.30.2 была установлена Ubuntu-server 11.04 x64.</p>
<blockquote>&nbsp;root@mail:/# uname -a<br /> &nbsp;Linux proxy 2.6.38-8-server #42-Ubuntu SMP Mon Apr 11 03:49:04 UTC 2011 x86_64 x86_64 x86_64 GNU/Linux</blockquote>
<p style="text-align: justify;">&nbsp;На сервер 192.168.0.2 был установлен Small Business Server 2011. Далее приведу настройки Exchange сервера. Их не много. Этих настроек хватит для обмена сообщениями между серверами с <a href="http://www.exonix.ru/?ginegxegy9oxteqoqzwsgvn.htm">ограничениями</a> по умолчанию. В начале добавляем наш домен в список разрешённых.</p>
<p>&nbsp;<img style="display: block; margin-left: auto; margin-right: auto;" alt="" src="http://fs.exonix.ru/ex1.png" /></p>
<p style="text-align: justify;">&nbsp;Далее создаём политику для E-mail адресов. Тут только одна настройка. Что такое %m я думаю вы догадаетесь сами, во время создания политики. У вас может будет другое значение, в зависимости от ваших предпочтений в наименований почтовых ящиков.</p>
<p>&nbsp;<img style="display: block; margin-left: auto; margin-right: auto;" alt="" src="http://fs.exonix.ru/ex2.png" /></p>
<p style="text-align: justify;">&nbsp;Далее создаём коннектор для отправки почты на внешний шлюз 192.168.30.2.</p>
<p>&nbsp;&nbsp;<img style="display: block; margin-left: auto; margin-right: auto;" alt="" src="http://fs.exonix.ru/ex3.png" /></p>
<p style="text-align: justify;">&nbsp;Переходим к настройке коннектора для получения почты.</p>
<p>&nbsp;<img style="display: block; margin-left: auto; margin-right: auto;" alt="" src="http://fs.exonix.ru/ex4.png" /></p>
<p style="text-align: justify;">В Exchange 2010 есть встроенный антиспам. Но по умолчанию он включён на запрет получения спама. Включение приёма и указания почтового ящика осуществляется здесь:</p>
<p><img style="display: block; margin-left: auto; margin-right: auto;" src="http://fs.exonix.ru/exch/2010/antispam.png" /></p>
<p style="text-align: justify;">&nbsp;Ну, а теперь приступим к самому интересному. Настройке Postfix и ClamAV. В Ubuntu я буду всегда работать под root. Мне так удобнее. При установке Postfix можно указывать любые параметры. Их всё равно потом можно будет поменять в конфигурационном файле.</p>
<blockquote>&nbsp;root@mail:/#apt-get install postfix</blockquote>
<p style="text-align: justify;">&nbsp;Конфигурационный файл /etc/postfix/main.cf. Привожу пример своего уже рабочего конфига. Красным я выделил то, что должно быть разным у нас с вами. Это ваш домен и IP адрес Exchange сервера.</p>
<p style="text-align: justify;">&nbsp;root@mail:/# cat /etc/postfix/main.cf</p>
<blockquote># See /usr/share/postfix/main.cf.dist for a commented, more complete version<br /> # Debian specific: &nbsp;Specifying a file name will cause the first<br /> # line of that file to be used as the name. &nbsp;The Debian default<br /> # is /etc/mailname.<br /> #myorigin = /etc/mailname<br /> smtpd_banner = $myhostname ESMTP $mail_name (Ubuntu)<br /> biff = no<br /> # appending .domain is the MUA's job.<br /> append_dot_mydomain = no<br /> # Uncomment the next line to generate "delayed mail" warnings<br /> #delay_warning_time = 4h<br /> readme_directory = no<br /> # TLS parameters<br /> smtpd_tls_cert_file = /etc/ssl/certs/smtpd.crt<br /> smtpd_tls_key_file = /etc/ssl/private/smtpd.key<br /> smtpd_use_tls = yes<br /> smtpd_tls_session_cache_database = btree:${data_directory}/smtpd_scache<br /> smtp_tls_session_cache_database = btree:${data_directory}/smtp_scache<br /> # See /usr/share/doc/postfix/TLS_README.gz in the postfix-doc package for<br /> # information on enabling SSL in the smtp client.<br /> <strong><span style="color: #ff0000;">myhostname = mail.ваш.домен<br /> mydomain = ваш.домен</span></strong><br /> alias_maps = hash:/etc/aliases<br /> alias_database = hash:/etc/aliases<br /> mydestination =<br /> relayhost =<br /> <strong><span style="color: #ff0000;">relay_domains = ваш.домен</span></strong><br /> relay_recipient_maps = hash:/etc/postfix/relay_recipients<br /> local_recipient_maps =<br /> <strong><span style="color: #ff0000;">mynetworks = 127.0.0.0/8 [::ffff:127.0.0.0]/104 [::1]/128 192.168.30.200/32</span></strong><br /> transport_maps = hash:/etc/postfix/transport<br /> mailbox_size_limit = 0<br /> recipient_delimiter = +<br /> inet_interfaces = all<br /> smtpd_sasl_local_domain =<br /> smtpd_sasl_auth_enable = yes<br /> smtpd_sasl_security_options = noanonymous<br /> broken_sasl_auth_clients = yes<br /> smtpd_recipient_restrictions = permit_sasl_authenticated,permit_mynetworks,reject_unauth_destination<br /> smtpd_tls_auth_only = no<br /> smtp_use_tls = yes<br /> smtp_tls_note_starttls_offer = yes<br /> smtpd_tls_CAfile = /etc/ssl/certs/cacert.pem<br /> smtpd_tls_loglevel = 1<br /> smtpd_tls_received_header = yes<br /> smtpd_tls_session_cache_timeout = 3600s<br /> tls_random_source = dev:/dev/urandom</blockquote>
<p style="text-align: justify;">&nbsp;Создадим два файла. Один&nbsp;указывает куда перенаправлять почту, второй содержит список разрешённых получателей. Второй список не обязателен, т.к. это можно настроить и в Exchange 2010. Если будите использовать, не забывайте его обновлять после создания новых почтовых ящиков.</p>
<blockquote>touch /etc/postfix/relay_recipients<br /> touch /etc/postfix/transport<br /> root@mail:/# cat /etc/postfix/transport<br /> ваш.домен &nbsp; &nbsp; smtp:[192.168.30.200]<br /> root@mail:/# cat /etc/postfix/relay_recipients<br /> admin@ваш.домен &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ok</blockquote>
<p style="text-align: justify;">&nbsp;Затем создадим так называемые "карты":</p>
<blockquote>&nbsp;postmap&nbsp;hash:/etc/postfix/relay_recipients<br /> &nbsp;postmap&nbsp;hash:/etc/postfix/transport</blockquote>
<p style="text-align: justify;">&nbsp;После этого создадутся два файла .db:&nbsp;relay_recipients.db &amp;&nbsp;transport.db</p>
<p style="text-align: justify;">&nbsp;Далее настроим сертификаты для TSL. Нужно вводить команды по очереди и отвечать на предложенные вопросы.</p>
<blockquote>openssl genrsa -des3 -rand /etc/hosts -out smtpd.key 1024<br /> chmod 600 smtpd.key<br /> openssl req -new -key smtpd.key -out smtpd.csr<br /> openssl x509 -req -days 3650 -in smtpd.csr -signkey smtpd.key -out smtpd.crt<br /> openssl rsa -in smtpd.key -out smtpd.key.unencrypted<br /> mv -f smtpd.key.unencrypted smtpd.key<br /> openssl req -new -x509 -extensions v3_ca -keyout cakey.pem -out cacert.pem -days 3650<br /> mv smtpd.key /etc/ssl/private/<br /> mv smtpd.crt /etc/ssl/certs/<br /> mv cakey.pem /etc/ssl/private/</blockquote>
<p style="text-align: justify;">&nbsp; С настрйокой Postfix пока всё. Его можно запустить: postfix start. Теперь нужно настроить SMTP-аутентификацию. Для этого будем использовать SASL. Установим необходимые пакеты libsasl2, sasl2-bin. Правда первый у меня уже был установлен:</p>
<blockquote>apt-get install&nbsp;libsasl2<br />apt-get install&nbsp;sasl2-bin</blockquote>
<p style="text-align: justify;">&nbsp;Потом нужно сделать вот это и не спрашивайте меня почему. Так надо. Это связанно с chroot. Ниже есть ссылки, там немного описано для чего это.</p>
<blockquote>mkdir -p /var/spool/postfix/var/run/saslauthd<br /> rm -rf /var/run/saslauthd</blockquote>
<p style="text-align: justify;">&nbsp;Отредактируем конфигурационный файл&nbsp;/etc/default/saslauthd. У меня вот такой. Красным я выделил сделанные изменения.</p>
<blockquote>root@mail:/# cat /etc/default/saslauthd<br /># Settings for saslauthd daemon<br /> # Please read /usr/share/doc/sasl2-bin/README.Debian for details.<br /> # Should saslauthd run automatically on startup? (default: no)<br /> START=<strong><span style="color: #ff0000;">yes</span></strong><br /> <strong><span style="color: #ff0000;">PWDIR="/var/spool/postfix/var/run/saslauthd"<br /> PARAMS="-m ${PWDIR}"<br /> PIDFILE="${PWDIR}/saslauthd.pid"</span></strong><br /> # Description of this saslauthd instance. Recommended.<br /> # (suggestion: SASL Authentication Daemon)<br /> DESC="SASL Authentication Daemon"<br /> # Short name of this saslauthd instance. Strongly recommended.<br /> # (suggestion: saslauthd)<br /> NAME="saslauthd"&nbsp;<br /> # Which authentication mechanisms should saslauthd use? (default: pam)<br /># Available options in this Debian package:<br /> # getpwent &nbsp;-- use the getpwent() library function<br /> # kerberos5 -- use Kerberos 5<br /> # pam &nbsp; &nbsp; &nbsp; -- use PAM<br /> # rimap &nbsp; &nbsp; -- use a remote IMAP server<br /> # shadow &nbsp; &nbsp;-- use the local shadow password file<br /> # sasldb &nbsp; &nbsp;-- use the local sasldb database file<br /> # ldap &nbsp; &nbsp; &nbsp;-- use LDAP (configuration is in /etc/saslauthd.conf)<br /># Only one option may be used at a time. See the saslauthd man page<br /> # for more information.<br /># Example: MECHANISMS="pam"<br /> MECHANISMS="pam"&nbsp;<br /> # Additional options for this mechanism. (default: none)<br /> # See the saslauthd man page for information about mech-specific options.<br /> MECH_OPTIONS=""&nbsp;<br /> # How many saslauthd processes should we run? (default: 5)<br /> # A value of 0 will fork a new process for each connection.<br /> THREADS=5&nbsp;<br /> # Other options (default: -c -m /var/run/saslauthd)<br /> # Note: You MUST specify the -m option or saslauthd won't run!<br /># WARNING: DO NOT SPECIFY THE -d OPTION.<br /> # The -d option will cause saslauthd to run in the foreground instead of as<br /> # a daemon. This will PREVENT YOUR SYSTEM FROM BOOTING PROPERLY. If you wish<br /> # to run saslauthd in debug mode, please run it by hand to be safe.<br /># See /usr/share/doc/sasl2-bin/README.Debian for Debian-specific information.<br /> # See the saslauthd man page and the output of 'saslauthd -h' for general<br /> # information about these options.<br /># Example for postfix users: "-c -m /var/spool/postfix/var/run/saslauthd"<br /> OPTIONS="-c -m /var/run/saslauthd"</blockquote>
<p style="text-align: justify;">&nbsp;Обновим конфигурацию:</p>
<blockquote>dpkg-statoverride --force --update --add root sasl 755 /var/spool/postfix/var/run/saslauthd</blockquote>
<p style="text-align: justify;">&nbsp;Приступим к настройке антивируса ClamAV. Вначале его нужно установить, а таже демон:</p>
<blockquote>apt-get install clamav<br />apt-get install clamsmtpd</blockquote>
<p style="text-align: justify;">&nbsp;Конфигурационный файл. Править там ничего не стал, хотя многие рекомендуют поменять сокет с&nbsp;clamd.ctl на clamd.sock.</p>
<blockquote>root@mail:/# cat /etc/clamav/clamd.conf<br /> #Automatically Generated by clamav-base postinst<br /> #To reconfigure clamd run #dpkg-reconfigure clamav-base<br /> #Please read /usr/share/doc/clamav-base/README.Debian.gz for details<br /> <span style="color: #ff0000;">LocalSocket /var/run/clamav/clamd.ctl</span><br /> FixStaleSocket true<br /> LocalSocketGroup clamav<br /> LocalSocketMode 666<br /> # TemporaryDirectory is not set to its default /tmp here to make overriding<br /> # the default with environment variables TMPDIR/TMP/TEMP possible<br /> User clamav<br /> AllowSupplementaryGroups true<br /> ScanMail true<br /> ScanArchive true<br /> ArchiveBlockEncrypted false<br /> MaxDirectoryRecursion 15<br /> FollowDirectorySymlinks false<br /> FollowFileSymlinks false<br /> ReadTimeout 180<br /> MaxThreads 12<br /> MaxConnectionQueueLength 15<br /> LogSyslog false<br /> LogFacility LOG_LOCAL6<br /> LogClean false<br /> LogVerbose false<br /> PidFile /var/run/clamav/clamd.pid<br /> DatabaseDirectory /var/lib/clamav<br /> SelfCheck 3600<br /> Foreground false<br /> Debug false<br /> ScanPE true<br /> ScanOLE2 true<br /> ScanHTML true<br /> DetectBrokenExecutables false<br /> ExitOnOOM false<br /> LeaveTemporaryFiles false<br /> AlgorithmicDetection true<br /> ScanELF true<br /> IdleTimeout 30<br /> PhishingSignatures true<br /> PhishingScanURLs true<br /> PhishingAlwaysBlockSSLMismatch false<br /> PhishingAlwaysBlockCloak false<br /> DetectPUA false<br /> ScanPartialMessages false<br /> HeuristicScanPrecedence false<br /> StructuredDataDetection false<br /> CommandReadTimeout 5<br /> SendBufTimeout 200<br /> MaxQueue 100<br /> ExtendedDetectionInfo true<br /> OLE2BlockMacros false<br /> StreamMaxLength 25M<br /> LogFile /var/log/clamav/clamav.log<br /> LogTime true<br /> LogFileUnlock false<br /> LogFileMaxSize 0<br /> Bytecode true<br /> BytecodeSecurity TrustSigned<br /> BytecodeTimeout 60000<br /> OfficialDatabaseOnly false<br /> CrossFilesystems true</blockquote>
<p style="text-align: justify;">&nbsp;Правим конфигурационный файл clamsmtpd.conf:</p>
<blockquote>root@mail:/# cat /etc/clamsmtpd.conf<br /> # ------------------------------------------------------------------------------<br /> # &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;SAMPLE CLAMSMTPD CONFIG FILE<br /> # ------------------------------------------------------------------------------<br /># - Comments are a line that starts with a #<br /> # - All the options are found below with their defaults commented out<br /> # The address to send scanned mail to.<br /> # This option is required unless TransparentProxy is enabled<br /> <span style="color: #ff0000;"><strong>OutAddress: 10025</strong></span><br /> # The maximum number of connection allowed at once.<br /> # Be sure that clamd can also handle this many connections<br /> #MaxConnections: 64<br /> # Amount of time (in seconds) to wait on network IO<br /> #TimeOut: 180<br /> # Address to listen on (defaults to all local addresses on port 10025)<br /> <strong><span style="color: #ff0000;">Listen: 127.0.0.1:10026</span></strong><br /> # The address clamd is listening on<br /> <strong><span style="color: #ff0000;">ClamAddress: /var/run/clamav/clamd.ctl</span></strong><br /> # A header to add to all scanned email<br /> #Header: X-AV-Checked: ClamAV using ClamSMTP<br /> # Directory for temporary files<br /> # TempDirectory: /var/spool/clamsmtp<br /> <strong><span style="color: #ff0000;">TempDirectory: /tmp</span></strong><br /> # PidFile: location of PID file<br /> PidFile: /var/run/clamsmtp/clamsmtpd.pid<br /> # Whether or not to bounce email (default is to silently drop)<br /> #Bounce: off<br /> # Whether or not to keep virus files<br /> #Quarantine: off<br /> # Enable transparent proxy support<br /> #TransparentProxy: off<br /> # User to run as<br /> <strong><span style="color: #ff0000;">User: clamsmtp</span></strong><br /> # Virus actions: There's an option to run a script every time a<br /> # virus is found. Read the man page for clamsmtpd.conf for details.</blockquote>
<p style="text-align: justify;">&nbsp;Обратите внимание на OutAdrress и Listen. Во многих (да почти во всех) значения меняют на оборот. Я тоже менял - не работало. Когда второй раз начал настраивать, решил не менять - всё ок. Теперь добавим две строчки в файл&nbsp;/etc/postfix/main.cf:</p>
<blockquote><strong>content_filter = scan:127.0.0.1:10026</strong><br /> <strong>receive_override_options = no_address_mappings</strong></blockquote>
<p style="text-align: justify;">&nbsp;</p>
<p style="text-align: justify;">&nbsp;И последня правка одного конфигурационного файла postfix /etc/postfix/master.cf. Туда нужно добавить несколько строк. Вот эти строчки:</p>
<blockquote># AV scan filter (used by content_filter)<br /> scan &nbsp; &nbsp; &nbsp;unix &nbsp;- &nbsp; &nbsp; &nbsp; - &nbsp; &nbsp; &nbsp; n<span class="Apple-tab-span" style="white-space: pre;"> </span>- &nbsp; &nbsp; &nbsp; 16 &nbsp; &nbsp; &nbsp;smtp<br /> &nbsp; &nbsp; &nbsp; &nbsp; -o smtp_send_xforward_command=yes<br /> # For injecting mail back into postfix from the filter<br /> 127.0.0.1:10025 inet &nbsp;n - &nbsp; &nbsp; &nbsp; n<span class="Apple-tab-span" style="white-space: pre;"> </span>- &nbsp; &nbsp; &nbsp; 16 &nbsp; &nbsp; &nbsp;smtpd<br /> &nbsp; &nbsp; &nbsp; &nbsp; -o content_filter=<br /> &nbsp; &nbsp; &nbsp; &nbsp; -o receive_override_options=no_unknown_recipient_checks,no_header_body_checks<br /> &nbsp; &nbsp; &nbsp; &nbsp; -o smtpd_helo_restrictions=<br /> &nbsp; &nbsp; &nbsp; &nbsp; -o smtpd_client_restrictions=<br /> &nbsp; &nbsp; &nbsp; &nbsp; -o smtpd_sender_restrictions=<br /> &nbsp; &nbsp; &nbsp; &nbsp; -o smtpd_recipient_restrictions=<span style="color: #ff0000;"><strong>permit_mynetworks,reject</strong></span><br /> &nbsp; &nbsp; &nbsp; &nbsp; -o mynetworks_style=host<br /> &nbsp; &nbsp; &nbsp; &nbsp; -o smtpd_authorized_xforward_hosts=127.0.0.0/8</blockquote>
<p style="text-align: justify;">&nbsp;Обратите внимание на правильность этих строк. Я встречал статьи, где <span style="color: #ff0000;"><strong>permit_mynetworks,reject</strong></span> находились не сразу после знака =, а на другой строчке. При перезапуске postfix вы получили бы ошибку о неверной записи в строке такой-то.</p>
<p style="text-align: justify;">&nbsp;Всё, делаем куищще (reboot) и проверяем работу почты. Я делал по следующим статьям:&nbsp;<a href="http://samag.ru/archive/article/280">http://samag.ru/archive/article/280</a>&nbsp;- тут я наткнулся на строчки "Повторяю еще раз, что мы описываем взаимодействие Postfix и Exchange, и если вы не видите здесь строчек, касающихся smtp-аутентификации или еще чего-либо, <em>то это не значит, что этого не должно быть в конфигурации вашего сервера.</em>" После этого нашёл вот эту статью:&nbsp;<a href="http://www.linuxcookbook.ru/books/ubuntu/serverguide/ru/email-services.html">www.linuxcookbook.ru/books/ubuntu/serverguide/ru/email-services.html</a>&nbsp;А антивирус устанавливал по этой статье:&nbsp;<a href="http://www.nixp.ru/articles/ClamAV-Plus-clamsmtpd-Plus-Postfix.html">http://www.nixp.ru/articles/ClamAV-Plus-clamsmtpd-Plus-Postfix.html</a>.&nbsp;Как видите, статьи не новые. Моя статья касается Exchange 2010 SP1, Ubuntu-server 11.04 x64, postfix 2.8.2, clamsmtpd 1.10.&nbsp;</p>
<p style="text-align: right;"><em>20.08.2011</em></p>
<p style="text-align: justify;">&nbsp;</p>
<p style="text-align: justify;">&nbsp;P.s. для себя: для чистой установки Exchange понадобится два пакета установить:</p>
<p style="text-align: justify;">-&nbsp;<a href="http://www.microsoft.com/en-us/download/details.aspx?id=17062">http://www.microsoft.com/en-us/download/details.aspx?id=17062</a></p>
<p style="text-align: justify;">- второй позже напишу. вроде это&nbsp;<a href="http://www.microsoft.com/en-us/download/details.aspx?id=4705">http://www.microsoft.com/en-us/download/details.aspx?id=4705</a>&nbsp;для роли unified messaging</p>
<p style="text-align: justify;"></p>
<div id="vk_comments"></div>
</body>
</html>