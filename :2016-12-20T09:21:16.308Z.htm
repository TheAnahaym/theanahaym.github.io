<!DOCTYPE html>
<html>
<head>
</head>
<body>
<p style="text-align: center;">&nbsp;<strong>Аудит сервера печати.</strong> Версия 2</p>
<p style="text-align: justify;">&nbsp;Статья для настройки аудита сервера печати <strong>2012 R2</strong> с помощью PowerShell и хранением данных в <strong>MS SQL Server 2016</strong> (<a href="/Статьи/MS_SQL/MS_SQL_2016_on_Debian/">установленном на Linux</a>). Подробное описание всех переменных в <a href="/Статьи/PowerShell/Аудит_сервера_печати/">предыдущей статье</a>. Создание базы данных и необходимых таблиц в PowerShell:</p>
<pre>$SQLServer = "<strong><span style="color: #ff0000;">192.168.0.111</span></strong>"<br />$uid ="SA"<br />$pwd = "<span style="color: #ff0000;"><strong>********</strong></span>"<br />Invoke-Sqlcmd -Query "CREATE DATABASE [PRINT];" -ServerInstance "$SQLServer" -Username $uid -Password $pwd<br />Invoke-Sqlcmd -Query "USE [PRINT]<br />CREATE Table LOG<br />(<br />UserName varchar(30) NOT NULL,<br />Printer varchar(30) NOT NULL,<br />Port varchar(30) NOT NULL,<br />PrintedTime datetime NOT NULL,<br />DocumentName varchar(250) NOT NULL,<br />Pages varchar(11) NOT NULL,<br />Copies varchar(11),<br />Size varchar (11) NOT NULL);" -ServerInstance "$SQLServer" -Username $uid -Password $pwd</pre>
<p>&nbsp;Включение отображения в логах имён распечатанных документов:</p>
<p style="text-align: justify;"><img src="http://fs.exonix.ru/2012R2/print/print4.png" alt="" width="778" height="696" caption="false" class="" style="display: block; margin-left: auto; margin-right: auto;" /><br />&nbsp;Скрипт для чтения и записи всех логов за все дни <strong>кроме текущего</strong>. Скрипт выполняется на сервере печати. В противном случае, на сервере печати нужно разрешать удалённое чтение логов и добавлять ключ -ComputerName к команде Get-WinEvent. Данный скрипт запускается <strong>только один раз при начальной конфигурации</strong>:</p>
<pre><span>$SQLServer = "</span><span></span><strong><span style="color: #ff0000;">192.168.0.111</span></strong><span>"</span><br /><span>$uid ="SA"</span><br /><span>$pwd = "</span><span></span><span style="color: #ff0000;"><strong>********</strong></span><span>"</span><br /><span>$today = get-date -DisplayHint date -UFormat %Y-%m-%d</span><br /><span>Get-WinEvent -FilterHashTable @{LogName="Microsoft-Windows-PrintService/Operational";<span style="color: #ff0000;"><strong>endtime</strong></span></span><span><span style="color: #ff0000;"><strong>="$today"</strong></span>;id=307} | Foreach { </span><br /><span>$event = [xml]$_.ToXml() </span><br /><span>if($event) </span><br /><span>{ </span><br /><span>$Time = Get-Date $_.TimeCreated -UFormat "%Y-%m-%d %H:%M:%S" </span><br /><span># $Job = $event.Event.UserData.DocumentPrinted.Param1 </span><br /><span>$Document = $event.Event.UserData.DocumentPrinted.Param2.ToString().Replace("\","\\") </span><br /><span>$User = $event.Event.UserData.DocumentPrinted.Param3 </span><br /><span>$Port = $event.Event.UserData.DocumentPrinted.Param6 </span><br /><span>$Printer = $event.Event.UserData.DocumentPrinted.Param5 </span><br /><span>$Size = $event.Event.UserData.DocumentPrinted.Param7 </span><br /><span>$Pages = $event.Event.UserData.DocumentPrinted.Param8 </span><br /><span>Invoke-Sqlcmd -Query "USE [PRINT]; INSERT INTO [LOG] (<br />UserName,Printer,Port,PrintedTime,DocumentName,Pages,Size) VALUES ('$User','$Printer','$Port','$Time','$Document','$Pages','$Size'</span><br /><span>);" -ServerInstance "$SQLServer" -Username $uid -Password $pwd</span><br /><span> }</span><br /><span>}</span><br /><span>Get-WinEvent -FilterHashTable @{LogName="Microsoft-Windows-PrintService/Operational";<span style="color: #ff0000;"><strong>endtime</strong></span></span><span><span style="color: #ff0000;"><strong>="$today"</strong></span>;</span><span>id=805} | Foreach { </span><br /><span>$event = [xml]$_.ToXml() </span><br /><span>if($event) </span><br /><span>{ </span><br /><span>$Time = Get-Date $_.TimeCreated -UFormat "%Y-%m-%d %H:%M:%S" </span><br /><span>$Copy = $event.Event.UserData.RenderJobDiag.Copies </span><br /><span>Invoke-Sqlcmd -Query "USE [PRINT]; UPDATE [LOG] SET Copies='$Copy' WHERE PrintedTime='$Time';" -ServerInstance "$SQLServer" -Username $uid -Password $pwd</span><br /><span> }</span><br /><span>}</span></pre>
<p style="text-align: justify;">&nbsp;Скрипт на чтение логов и запись в базу данных за <strong>текущий день</strong>, который выполняется на сервере печати&nbsp;<strong>каждый вечер</strong> в 23:55 (при условии, что в последние 5 минут суток никто печатать не будет):</p>
<pre>$SQLServer = "<strong><span style="color: #ff0000;">192.168.0.111</span></strong>"<br />$uid ="SA"<br />$pwd = "<span style="color: #ff0000;"><strong>********</strong></span>"<br />$today = get-date -DisplayHint date -UFormat %Y-%m-%d<br />Get-WinEvent -FilterHashTable @{LogName="Microsoft-Windows-PrintService/Operational";<strong><span style="color: #ff0000;">starttime="$today"</span></strong>;id=307} | Foreach { <br /> $event = [xml]$_.ToXml() <br /> if($event) <br /> { <br /> $Time = Get-Date $_.TimeCreated -UFormat "%Y-%m-%d %H:%M:%S" <br /># $Job = $event.Event.UserData.DocumentPrinted.Param1 <br /> $Document = $event.Event.UserData.DocumentPrinted.Param2.ToString().Replace("\","\\") <br /> $User = $event.Event.UserData.DocumentPrinted.Param3 <br /> $Port = $event.Event.UserData.DocumentPrinted.Param6 <br /> $Printer = $event.Event.UserData.DocumentPrinted.Param5 <br /> $Size = $event.Event.UserData.DocumentPrinted.Param7 <br /> $Pages = $event.Event.UserData.DocumentPrinted.Param8 <br />Invoke-Sqlcmd -Query "USE [PRINT]; INSERT INTO [LOG] (<br />UserName,Printer,Port,PrintedTime,DocumentName,Pages,Size) VALUES ('$User','$Printer','$Port','$Time','$Document','$Pages','$Size'<br />);" -ServerInstance "$SQLServer" -Username $uid -Password $pwd<br /> }<br />}<br />Get-WinEvent -FilterHashTable @{LogName="Microsoft-Windows-PrintService/Operational";<span><strong><span style="color: #ff0000;">starttime="$today"</span></strong>;</span>id=805} | Foreach { <br />$event = [xml]$_.ToXml() <br />if($event) <br />{ <br />$Time = Get-Date $_.TimeCreated -UFormat "%Y-%m-%d %H:%M:%S" <br />$Copy = $event.Event.UserData.RenderJobDiag.Copies <br />Invoke-Sqlcmd -Query "USE [PRINT]; UPDATE [LOG] SET Copies='$Copy' WHERE PrintedTime='$Time';" -ServerInstance "$SQLServer" -Username $uid -Password $pwd<br /> }<br />}</pre>
<p>&nbsp;Вот так примерно выглядит заполненная база данных:</p>
<pre>UserName PrinterName                     PrintersIpAddress PrintedTime              DocumentName                 Pages Copies Size<br />User1    HP LaserJet 200 color MFP M276  192.168.0.22      2016-12-20 10:03:18.000  Microsoft Word - Document1   2     1      631304<br />User1    HP LaserJet 200 color MFP M276  192.168.0.22      2016-12-19 11:17:19.000  Microsoft Outlook - Subject  2     1      155984<br />User2    HP LaserJet 200 color MFP M276  192.168.0.22      2016-12-19 11:16:48.000  Google Translate             2     1      157755<br />User2    HP LaserJet 200 color MFP M276  192.168.0.22      2016-12-16 17:35:10.000  Invoice 2016.12.13.pdf       1     1      319200<br />User3    HP LaserJet 200 color MFP M276  192.168.0.22      2016-12-16 17:13:14.000  11-2016.pdf                  1     1      459720</pre>
<p style="text-align: justify;">&nbsp;Веб-интерфейс настраивается в моём случае на сервере Linux (там же где установлен MS SQL Server 2016). Так же его можно настроить на любом Веб-сервере.</p>
</body>
</html>