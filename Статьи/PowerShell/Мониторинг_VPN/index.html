<!doctype html><html><head><meta name="generator" content="kosmos3.com"/><meta charset="utf-8"/><title>Мониторинг VPN</title><base href="/"/><meta name="description" content=""/><meta name="viewport" content="width=device-width,initial-scale=1"/><meta property="og:title" content="Мониторинг VPN"/><meta property="og:description" content=""/><meta property="og:type" content="website"/><meta property="og:url" content="https://exonix.ru/%D0%A1%D1%82%D0%B0%D1%82%D1%8C%D0%B8/PowerShell/%D0%9C%D0%BE%D0%BD%D0%B8%D1%82%D0%BE%D1%80%D0%B8%D0%BD%D0%B3_VPN/"/><meta property="og:image" content=" "/><meta name="google-site-verification" content=""/><meta name="yandex-verification" content="782d99977f221efc"/><meta name="keywords" content=""/><link rel="canonical" href="https://exonix.ru/%D0%A1%D1%82%D0%B0%D1%82%D1%8C%D0%B8/PowerShell/%D0%9C%D0%BE%D0%BD%D0%B8%D1%82%D0%BE%D1%80%D0%B8%D0%BD%D0%B3_VPN/"/><link rel="icon" href="/favicon.ico" sizes="any"/><link rel="icon" href="/icon.svg" type="image/svg+xml"/><link rel="apple-touch-icon" href="icon.png"/><script defer="defer" src="35987de043eadfbac029.js"></script><script defer="defer" src="6e8da963a952f290426e.js"></script><script defer="defer" src="caab2fd6f178a464e783.js"></script><script defer="defer" src="cea3e0bef8bcd170fd9e.js"></script><script defer="defer" src="caa6139840eae963be39.js"></script><script defer="defer" src="eacd0d418788166e2ae1.js"></script><script defer="defer" src="b403ba1b50235d0c77a0.js"></script><script defer="defer" src="2f2c125db900c7def701.js"></script><script defer="defer" src="a2c9a3d6441fa7f47144.js"></script><script defer="defer" src="cc7419fd89288af206a6.js"></script><script defer="defer" src="d62024abe8947a74a2f5.js"></script><script defer="defer" src="ce2c7263ca855fbcb35e.js"></script><script defer="defer" src="c59175f9ca99e24d1bd3.js"></script><script defer="defer" src="9217eeb01724e3ff8b12.js"></script><script defer="defer" src="8d951af21d9a2fb61271.js"></script><script defer="defer" src="d140a0646d371e2d543d.js"></script><script defer="defer" src="ba7c8ee9b295f8df014d.js"></script><script defer="defer" src="d6d17816db46260d76a9.js"></script><script defer="defer" src="fb202151454e4df03fcb.js"></script><link href="464b4ab657e789bb6f9b.css" rel="stylesheet"><link href="675ab082df3cfd69353d.css" rel="stylesheet"><link href="b13f62cc09d29239cd87.css" rel="stylesheet"><link href="82eda635a394addd3694.css" rel="stylesheet"><link href="325ca391f07b17edc66b.css" rel="stylesheet"><link href="bedb80fb32fde87c536e.css" rel="stylesheet"><link href="d3a65e4b5830dc71eb5a.css" rel="stylesheet"><link href="6331727f9e074c2cd59f.css" rel="stylesheet"><link href="index.cdn.css" rel="stylesheet"/><link href="index.css" rel="stylesheet"/><link rel="manifest" href="site.webmanifest"/><meta name="theme-color" content="#fafafa"/><script id="yandex">(function (m, e, t, r, i, k, a) {
        m[i] =
          m[i] ||
          function () {
            (m[i].a = m[i].a || []).push(arguments);
          };
        m[i].l = 1 * new Date();
        (k = e.createElement(t)),
          (a = e.getElementsByTagName(t)[0]),
          (k.async = 1),
          (k.src = r),
          a.parentNode.insertBefore(k, a);
      })(
        window,
        document,
        "script",
        "https://mc.yandex.ru/metrika/tag.js",
        "ym"
      );
      ym("55256677", "init", {
        id: "55256677",
        clickmap: true,
        trackLinks: true,
        accurateTrackBounce: true,
        ut: "noindex",
      });</script><script async="async" src="https://www.google-analytics.com/analytics.js"></script></head><body><div class="ui sidebar very wide vertical accordion menu"></div><div class="ui main menu fixed" hidden><a class="launch icon item"><i class="content icon"></i></a><div class="header item">Мониторинг VPN</div></div><div class="pusher"><div style="z-index: 8;" class="ui fluid container" data-absolute=""><div data-id="rmenu" data-menu-icons="false" data-icons="true" data-animation="true" data-close-on-click="true" data-direction="default" data-hover-delay="100" data-open-on-click="false" data-orientation="horizontal" data-popup-collision="true" data-scrollable="true" id="menu" class="" style="align-self: center; margin-top: 503px; border-style: none; border-color: rgb(204, 204, 204) rgb(204, 204, 204) rgb(204, 204, 204) rgb(0, 0, 0); color: rgb(102, 102, 102); opacity: 1; background-position: 0% 0%; background-repeat: repeat; background-attachment: scroll; background-size: auto;"></div></div><div data-static="" class="ui container" style="z-index: 7;"><div id="content" style="margin: 558px 4px 200px; min-height: 600px; flex: 1 1 auto; padding: 20px; border-width: 2px; border-style: double; border-color: rgb(204, 204, 204); color: rgb(102, 102, 102); opacity: 1; background-repeat: repeat; background-attachment: scroll;" class="well" data-turbomenu="false"><main v-if="!content"><!DOCTYPE html>
<html>
<head>
</head>
<body>
<p style="text-align: center;"><strong>Мониторинг VPN</strong></p>
<p>&nbsp;Хотите знать кто, когда и откуда подключался к вашему VPN серверу? Для этого понадобится один скрипт Powershell и&nbsp;база данных.<br />Собственно, сам Powershell скрипт, расположенный на&nbsp;RAIDUS сервере и&nbsp;который запускает планировщик задач каждую ночь в 00:05:</p>
<pre>Add-Type -Path "C:\Program Files (x86)\MySQL\MySQL Connector Net 6.9.8\Assemblies\v4.5\MySql.Data.dll" <br />$connectionString = "server=mysql1;uid=root;pwd=asdASD;database=VPN;" <br />$connection = New-Object MySql.Data.MySqlClient.MySqlConnection <br />$connection.ConnectionString = $connectionString <br />$connection.Open() <br />$sql = New-Object MySql.Data.MySqlClient.MySqlCommand <br />$sql.Connection = $connection<br />$today = get-date -DisplayHint date -UFormat %Y-%m-%d<br />$yesterday = get-date (get-date).addDays(-1) -UFormat %Y-%m-%d<br />#Get-WinEvent -FilterHashTable @{LogName="security";endtime="$today";id=6272} | Foreach {<br />Get-WinEvent -FilterHashTable @{LogName="security";starttime="$yesterday";endtime="$today";id=6272} | Foreach {<br />$Name = $_.Properties[0].Value<br />$FullName = (Get-ADUser $Name).Name<br />$LocalIP = $_.Properties[8].Value<br />$RemoteIP = $_.Properties[9].Value<br />$Time = Get-Date $_.TimeCreated -UFormat "%H:%M:%S"<br />$Date = Get-Date $_.TimeCreated -UFormat "%Y-%m-%d"<br />$sql.CommandText = "INSERT INTO connections (Day,Login,Name,VPN_IP,Client_IP) VALUES ('$Date','$Time','$FullName','$LocalIP','$RemoteIP')" <br />&nbsp;&nbsp; $sql.ExecuteNonQuery()<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />$connection.Close()</pre>
<p>&nbsp;Комментарии по скрипту:</p>
<p>&nbsp;- первая строка: путь&nbsp;к <a href="https://dev.mysql.com/downloads/connector/net/" target="_blank" rel="noopener">коннектору</a>, с помощью которого Powershell подключается к базе данных MySQL на Debian.<br />&nbsp;- вторая строка: подключение к серверу mysql1 под учётной записью root (root от MySQL, а не от сервера Debian).<br />&nbsp;- восьмая строка: определение текущей даты.<br />&nbsp;- девятая строка: определение вчерашней даты.<br />&nbsp;- десятая строка: чтение всех событий в журнале безопасности. Эту строку следует <strong>рас</strong>комментировать при первом ручном&nbsp;запуске скрипта.<br />&nbsp;- одиннадцатая строка: чтение событий в журнале безопасности за вчерашний день. Эту строку следует <strong>за</strong>комментировать при первом ручном&nbsp;запуске скрипта.<br />&nbsp;-&nbsp;<strong>Name</strong> и <strong>FullName</strong>: определение&nbsp;полного имени пользователя по его SID. SID всегда постоянен, а вот в логах могут стоять имена пользователей в разных видах. Например, Username или DOMAIN\Username.<br />&nbsp;- <strong>LocalIP</strong>: IP адрес VPN сервера. Вдруг их несколько.<br />&nbsp;- <strong>RemoteIP</strong>: внешний&nbsp;IP адрес, с которого подключается клиент.<br />&nbsp;- <strong>Time</strong>: время подключения.<br />&nbsp;- <strong>Date</strong>: день подключения.<br />&nbsp;- Последние четыре строки: выполнение запроса MySQL - запись в базу данных.</p>
<p>&nbsp;Вот такие две таблицы должны быть созданы в базе данных VPN:</p>
<pre>mysql&gt; <strong>show create table `connections`</strong>;<br />+-------------+------------------------------+<br />| Table&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | Create Table&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |<br />+-------------+------------------------------+<br />| connections | CREATE TABLE `connections` (<br />&nbsp; `Day` date NOT NULL,<br />&nbsp; `Login` time NOT NULL,<br />&nbsp; `Name` varchar(30) NOT NULL,<br />&nbsp; `VPN_IP` varchar(15) NOT NULL,<br />&nbsp; `Client_IP` varchar(15) NOT NULL,<br />&nbsp; `Country2` varchar(255) NOT NULL<br />) ENGINE=InnoDB DEFAULT CHARSET=utf8 |<br />+-------------+------------------------------+<br />1 row in set (0.00 sec)<br /><br />mysql&gt; <strong>show create table `IPs`</strong>;<br />+-------+------------------------------------+<br />| Table | Create Table&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |<br />+-------+------------------------------------+<br />| IPs&nbsp;&nbsp; | CREATE TABLE `IPs` (<br />&nbsp; `StartIP` varchar(15) NOT NULL,<br />&nbsp; `EndIP` varchar(15) NOT NULL,<br />&nbsp; `Country` varchar(255) NOT NULL<br />) ENGINE=InnoDB DEFAULT CHARSET=utf8 |<br />+-------+------------------------------------+<br />1 row in set (0.00 sec)</pre>
<p>&nbsp;После этого, база данных будет выглядеть так:<br /><img width="540" height="140" style="margin-right: auto; margin-left: auto; display: block;" alt="" src="http://fs.exonix.ru/powershell/vpnmon/vpnmon1.png" />&nbsp;Теперь необходимо определить, какой стране принадлежит IP адрес пользователя VPN. Есть несколько способов, в том числе определение онлайн через php, но&nbsp;мне это намного&nbsp;сложнее сделать, да к тому же определение будет выполняться всякий раз, при обновлении веб-страницы. По этому,&nbsp;создаём ещё одну таблицу в базе данных, в которую импортируем файл <a href="http://fs.exonix.ru/powershell/vpnmon/ip.csv">CSV с IP и странами</a>, последнюю версию "GeoLite Country" которого можно скачать <a href="http://dev.maxmind.com/geoip/legacy/geolite/" target="_blank" rel="noopener">тут</a>. Импорт я делал через <a href="http://www.heidisql.com/download.php">HeidiSQL</a>.<br />&nbsp;Теперь необходимо настроить MySQL так, чтобы он проверял IP, и записывал соответствующую страну в поле Country2. Для этого используется планировщик событий MySQL. Скрипт выполняется на две минуты позже, после скрипта PowerShell:</p>
<pre>CREATE EVENT `Country Update` ON SCHEDULE EVERY 1 DAY STARTS "2016-06-26 00:07:00" DO UPDATE connections SET connections.country2 = (SELECT IPs.country as country2 FROM IPs WHERE INET_ATON(connections.Client_IP) &gt;= INET_ATON(IPs.StartIP) AND INET_ATON(connections.Client_IP) &lt;= INET_ATON(IPs.EndIP) ) WHERE Client_IP=Client_IP AND COUNTRY2 = "";</pre>
<p>&nbsp;Команду после DO нужно выполнить сразу после ручного запуска скрипта Powershell. Если она написана правильно, то таблица примет вид:</p>
<p><img width="534" height="134" style="margin-right: auto; margin-left: auto; display: block;" alt="" src="http://fs.exonix.ru/powershell/vpnmon/vpnmon2.png" /></p>
<p>&nbsp;Проверку созданного события по расписанию можно проверить с помощью команды:</p>
<pre>SELECT * FROM INFORMATION_SCHEMA.EVENTS WHERE EVENT_NAME = 'Country update' AND EVENT_SCHEMA = 'VPN'\G;</pre>
<pre>*************************** 1. row ***************************<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; EVENT_CATALOG: def<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; EVENT_SCHEMA: VPN<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; EVENT_NAME: Country Update<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DEFINER: <a href="mailto:root@mysql1.domainad.domain.com">root@mysql1.domainad.domain.com</a><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; TIME_ZONE: SYSTEM<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; EVENT_BODY: SQL<br />&nbsp;&nbsp;&nbsp; EVENT_DEFINITION: UPDATE connections SET connections.country2 = (SELECT IPs.country as country2 FROM IPs WHERE INET_ATON(connections.Client_IP) &gt;= INET_ATON(IPs.StartIP) AND INET_ATON(connections.Client_IP) &lt;= INET_ATON(IPs.EndIP) ) WHERE Client_IP=Client_IP AND COUNTRY2 = ""<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; EVENT_TYPE: RECURRING<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; EXECUTE_AT: NULL<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; INTERVAL_VALUE: 1<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; INTERVAL_FIELD: DAY<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SQL_MODE:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; STARTS: 2016-06-26 00:07:00<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ENDS: NULL<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; STATUS: ENABLED<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ON_COMPLETION: NOT PRESERVE<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; CREATED: 2016-06-25 14:50:25<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LAST_ALTERED: 2016-06-25 14:50:25<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LAST_EXECUTED: 2016-07-02 00:07:00<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; EVENT_COMMENT:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ORIGINATOR: 0<br />CHARACTER_SET_CLIENT: utf8<br />COLLATION_CONNECTION: utf8_general_ci<br />&nbsp; DATABASE_COLLATION: utf8_general_ci<br />1 row in set (0.00 sec)<br /><br />ERROR:<br />No query specified</pre>
<p>&nbsp;На этом можно заканчивать. Если у вас есть знакомые веб-программисты, то они легко вам сделают веб-страницу с выводом нужной информации. Я же пока не буду выкладывать свой вариант, так как там не всё гладко работает... Примерно, это выглядит так:</p>
<p><img width="1023" height="276" style="margin-right: auto; margin-left: auto; display: block;" alt="" src="http://fs.exonix.ru/powershell/vpnmon/vpnmon3.png" /></p>
<p style="text-align: justify;">&nbsp;Если есть вопросы по настройке - спрашивайте, помогу. К сожалению, пока не нашёл, как можно определить выход пользователя, чтобы рассчитать время его сессии. А так же не нашёл как определить в логах по каким протоколам пользователь подключается к VPN. Например, у меня два сервера: L2TP на 2012 R2, и IKEv2 на 2008 R2, т.к. второй на 2012 R2 не работает. Если у вас есть какая-либо информация, буду рад если поделитесь в комментариях. Спасибо!</p>
<p style="text-align: right;">02.07.2016</p>
<div id="vk_comments"></div>
</body>
</html></main><main v-else v-html="content"></main></div></div><div data-absolute="" class="ui fluid container" style="z-index: 6;"><div id="roof-wrap1" style="min-width: 100%; align-self: center; margin-top: 0px; min-height: 483px; padding: 10px 0px 0px; border-width: 0px 0px 4px; border-style: none none solid; border-color: rgb(255, 255, 255) rgb(255, 255, 255) rgb(246, 187, 36); color: rgb(102, 102, 102); opacity: 1; background-color: rgb(255, 255, 255); background-position: 0% 0%; background-repeat: repeat; background-attachment: scroll; background-size: auto; box-shadow: rgb(0, 0, 0) 0px 0px 2px 2px; background-image: url(&quot;1567075815596/sama2.png&quot;);" class=""><div id="roof1" data-jkit="[slideshow:interval=7000;speed=250;animation=fade]"><img src="files/roof/dresden.jpg"><img src="files/roof/moskau.jpg"><img src="1589641442742/berlin.jpg"></div></div></div><div data-absolute="" style="z-index: 5;"><div id="roof-wrap2" style="margin-left: 0px; margin-right: 0px; margin-top: 0px; min-height: 155px; padding: 10px 0px 0px; border-width: 0px 0px 4px; border-style: none none solid; border-color: rgb(255, 255, 255) rgb(255, 255, 255) rgb(246, 187, 36); color: rgb(102, 102, 102); opacity: 1; background-color: rgb(255, 255, 255); background-position: 0% 0%; background-repeat: repeat; background-attachment: scroll; background-image: url(&quot;1567075817539/sama2.png&quot;);" class=""><div id="roof2"><img src="files/roof/site2.gif" width="100%"></div></div></div><div data-absolute="" class="ui container" style="z-index: 4;"><div class="" id="copyright" style="margin-left: 5px; min-width: 50px; align-self: center; margin-bottom: 148px; min-height: 38px; border-style: none; border-color: rgb(0, 0, 0); color: rgb(102, 102, 102); opacity: 1; background-repeat: repeat; background-attachment: scroll;"><p><a style="color: #6aa3b1;" href="//redaktr.com" title="Redaktr.com - твой бесплатный сайт в облаке! Начни redaktировать прямо сейчас!"><i style="text-shadow: 1px 1px 1px black;" class="fa fa-cloud-upload fa-3x"></i></a></p></div></div><div data-absolute="" class="ui container" style="z-index: 3;"><div class="" id="live-internet" style="margin-left: 70px; min-width: 88px; align-self: center; margin-bottom: 149px; min-height: 31px; border-style: none; border-color: rgb(0, 0, 0); color: rgb(102, 102, 102); opacity: 1; background-repeat: repeat; background-attachment: scroll;"><p></p></div></div><div data-absolute="" style="z-index: 2;"><div id="main-footer" style="margin-left: 0px; margin-right: 0px; margin-bottom: 0px; min-height: 177px; border-style: none; border-color: rgb(0, 0, 0); color: rgb(102, 102, 102); opacity: 1; background-position: 50% 0px; background-repeat: no-repeat; background-attachment: scroll; background-image: url(&quot;1567149113516/motherboard.png&quot;);" class=""></div></div><div data-absolute="" style="z-index: 1;"><div id="wholebg" style="margin: 0px; flex: 1 1 auto; border-style: none; border-color: rgb(0, 0, 0); color: rgb(102, 102, 102); opacity: 1; background-position: 0% 0%; background-repeat: repeat; background-attachment: scroll; background-image: url(&quot;1567075817543/leather_1.png&quot;);" class=""></div></div></div></body></html>